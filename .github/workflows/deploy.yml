name: Deploy Frontend to NCP

on:
  push:
    branches: [main]

concurrency:
  group: deploy-frontend
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun run test

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/leviosa-frontend:latest
          build-args: |
            NEXT_PUBLIC_CS_API_URL=${{ vars.NEXT_PUBLIC_CS_API_URL }}
            NEXT_PUBLIC_SOURCING_API_URL=${{ vars.NEXT_PUBLIC_SOURCING_API_URL }}
            NEXT_PUBLIC_SUPABASE_URL=${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          no-cache: true

      - name: Create .env file
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
          echo "REPLICATE_API_TOKEN=${{ secrets.REPLICATE_API_TOKEN }}" >> .env
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.NCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.NCP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.NCP_SERVER_IP }} "mkdir -p ~/leviosa-frontend/nginx/ssl"
          scp -o StrictHostKeyChecking=no .env root@${{ secrets.NCP_SERVER_IP }}:~/leviosa-frontend/.env
          scp -o StrictHostKeyChecking=no docker-compose.prod.yml root@${{ secrets.NCP_SERVER_IP }}:~/leviosa-frontend/docker-compose.prod.yml
          scp -r -o StrictHostKeyChecking=no nginx/nginx.conf root@${{ secrets.NCP_SERVER_IP }}:~/leviosa-frontend/nginx/nginx.conf

      - name: Deploy to NCP Server
        run: |
          ssh root@${{ secrets.NCP_SERVER_IP }} << 'EOF'
          set -e
          cd ~/leviosa-frontend

          echo "Disk usage check..."
          DISK_USAGE=$(df --output=pcent / | tail -n1 | tr -dc '0-9')

          if ! command -v docker &> /dev/null; then
              echo "Docker is not installed. Install it first:"
              echo "sudo apt update && sudo apt install -y docker.io docker-compose-plugin"
              echo "sudo systemctl enable docker && sudo systemctl start docker"
              exit 1
          fi

          if ! docker compose version &> /dev/null; then
              echo "docker compose v2 is not installed."
              exit 1
          fi

          if [ "$DISK_USAGE" -ge 85 ]; then
              echo "Disk usage ${DISK_USAGE}% - cleaning Docker resources..."
              docker container prune -f
              docker image prune -af
              echo "Docker cleanup complete"
          fi

          echo "Setting SSL cert permissions..."
          chmod 644 ~/leviosa-frontend/nginx/ssl/origin.pem
          chmod 644 ~/leviosa-frontend/nginx/ssl/origin-key.pem

          echo "Logging into DockerHub..."
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

          if [ ! -f .env ]; then
              echo ".env file is missing."
              exit 1
          fi

          echo "Pulling latest image..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/leviosa-frontend:latest

          echo "Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down --remove-orphans || true

          echo "Starting containers..."
          export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
          docker compose -f docker-compose.prod.yml up -d || {
              echo "Container startup failed! Checking logs..."
              docker compose -f docker-compose.prod.yml logs --tail=50
              exit 1
          }

          echo "Waiting for healthcheck..."
          SUCCESS=false
          for i in $(seq 1 30); do
              if docker compose -f docker-compose.prod.yml ps frontend | grep -q "healthy"; then
                  echo "Healthcheck passed! (attempt: $i)"
                  SUCCESS=true
                  break
              elif docker compose -f docker-compose.prod.yml ps frontend | grep -q "Up"; then
                  echo "Container running, waiting for healthcheck... ($i/30)"
                  sleep 2
              else
                  echo "Waiting for service to start... ($i/30)"
                  sleep 2
              fi
          done

          if [ "$SUCCESS" != true ]; then
              echo "Healthcheck failed! Recent logs:"
              docker compose -f docker-compose.prod.yml logs --tail=50 frontend || true
              exit 1
          fi

          echo "Deploy complete!"
          EOF
